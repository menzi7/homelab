# certcopy.sh

## Purpose
The `certcopy.sh` script is used to copy the latest SSL certificate and private key generated by Certbot to the Docker Containers after every successful certificate renewal. This script is executed automatically via Certbot's `post_hook`.
```sh
# /etc/letsencrypt/renewal/pi.menzi.dk.conf
[renewalparams]
post_hook = sudo /bin/certcopy.sh
```

## What it Does
1. **Identifies the Latest Certificate and Private Key**:
   - The script searches the `/etc/letsencrypt/archive/<domain>/` directory to find the most recent versions of the certificate (`fullchain*.pem`) and the private key (`privkey*.pem`).
   - It uses the `ls -t` command to sort files by modification time, ensuring the latest certificate and key are selected.

2. **Copies the Files to the Containers Directory**:
   - The identified certificate and private key are copied to a destination directory (e.g., `containers/Zabbix/certs`) using the `cp` command.



## Security
Exposing port 80 to the internet can pose a security risk. To minimize this risk, additional precautions have been taken to restrict access to only what is necessary for Certbot's ACME challenge.

### Firewall
To control traffic to port 80, I followed [this guide](https://community.fortinet.com/t5/FortiGate/Technical-Tip-How-to-allow-Let-s-Encrypt-traffic-through-the/ta-p/334464) on configuring the firewall. The setup allows only ACME challenge traffic and blocks all other HTTP requests.

### NGINX
To secure port 80 further, NGINX is configured to strictly handle ACME challenges required for certificate validation by Certbot. This ensures that only the necessary requests for domain validation are processed, while all other traffic on port 80 is denied.

### Configuration File
The NGINX configuration file (e.g., `/etc/nginx/sites-available/pi.menzi`) is set up as follows:
```sh
server {
    listen 80;
    server_name pi.menzi.dk;

    # Allow ACME challenge traffic
    location /.well-known/acme-challenge/ {
        allow all;
    }

    # Deny all other traffic to port 80
    location / {
        return 403;
    }
}
```
